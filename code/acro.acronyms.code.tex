% ----------------------------------------------------------------------------
% the ACRO package - acronyms module
% 
%   Typeset Acronyms
% 
% --------------------------------------------------------------------------
% Clemens Niederberger
% Web:    https://github.com/cgnieder/acro/
% E-Mail: contact@mychemistry.eu
% --------------------------------------------------------------------------
% Copyright 2011--2020 Clemens Niederberger
% 
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
% 
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Clemens Niederberger.
% --------------------------------------------------------------------------
% If you have any ideas, questions, suggestions or bugs to report, please
% feel free to contact me.
% --------------------------------------------------------------------------
\AcroModule{acronyms}{define acronyms}

% --------------------------------------------------------------------------
\msg_new:nnn {acro} {undefined}
  {
    You've~ requested~ acronym~ `#1'~ \msg_line_context: \ but~ you~
    apparently~ haven't~ defined~ it,~ yet! \\
    Maybe~ you've~ misspelled~ `#1'?
  }

\msg_new:nnn {acro} {mandatory}
  {
    You~ forgot~ to~ set~ the~ mandatory~ property~ `#2'~ for~ acronym~
    `#1'~ \msg_line_context:
  }

% --------------------------------------------------------------------------
% short and long list:
\tl_new:N \l__acro_short_tl
\tl_new:N \l__acro_long_tl

\cs_new_protected:Npn \acro_list_add:nn #1#2
  {
    \clist_map_inline:nn {#2}
      {
        \tl_put_right:cn {l__acro_#1_tl} {{##1}}
        \cs_set:cpn {____acro_#1::##1____:} {}
      }
  }

\cs_new_protected:Npn \acro_list_map:nn #1#2
  { \tl_map_inline:cn {l__acro_#1_tl} {#2} }

\prg_new_conditional:Npnn \acro_if_short:n #1 {p,T,F,TF}
  {
    \cs_if_exist:cTF {____acro_short::#1____:}
      { \prg_return_true: }
      { \prg_return_false: }
  }

\prg_new_conditional:Npnn \acro_if_long:n #1 {p,T,F,TF}
  {
    \cs_if_exist:cTF {____acro_long::#1____:}
      { \prg_return_true: }
      { \prg_return_false: }
  }

% --------------------------------------------------------------------------
% define necessary properties:
\NewDocumentCommand \DeclareAcroProperty {st?t!t|m}
  { \acro_property_declare:nnnnn {#1} {#2} {#3} {#4} {#5} }

\NewDocumentCommand \DeclareAcroPropertyAlias {st?t!t|mm}
  {
    \acro_property_declare:nnnnn {#1} {#2} {#3} {#4} {#5}
    \acro_property_make_alias:nn {#5} {#6}
  }

% short and long properties:
\acro_list_add:nn {short} {short,alt}
\acro_list_add:nn {long}  {long,foreign,single,extra,list}

% meta information:
\DeclareAcroProperty*!{id}
\DeclareAcroProperty ?{used}
\DeclareAcroProperty |{usage}
\DeclareAcroProperty |{pages}
\DeclareAcroProperty |{barriers}
\DeclareAcroProperty* {label}

% main properties:
\DeclareAcroProperty !{short}
\DeclareAcroProperty  {alt}
\DeclareAcroProperty !{long}

% sorting, indexing, ... :
\DeclareAcroPropertyAlias {sort} {short}
\DeclareAcroProperty {index}
\DeclareAcroProperty?{no-index}
\DeclareAcroPropertyAlias {index-sort} {sort}
\DeclareAcroProperty {index-cmd}
\DeclareAcroProperty {tag}
\DeclareAcroProperty {cite}
\DeclareAcroPropertyAlias {pdfstring} {short}
\DeclareAcroProperty {pdfcomment}

% locale:
\DeclareAcroProperty {foreign}
\DeclareAcroProperty {foreign-babel}
\DeclareAcroProperty {foreign-locale}

% additional properties:
\DeclareAcroPropertyAlias {single} {long}
\DeclareAcroPropertyAlias {list} {long}
\DeclareAcroPropertyAlias {first-long} {long}
\DeclareAcroProperty {extra}
\DeclareAcroProperty {post}
\DeclareAcroProperty {first-style}
\DeclareAcroProperty {single-style}

% formatting:
\DeclareAcroProperty {format}
\DeclareAcroPropertyAlias {short-format} {format}
\DeclareAcroProperty {alt-format}
\DeclareAcroPropertyAlias {long-format}  {format}
\DeclareAcroProperty {first-long-format}
\DeclareAcroProperty {foreign-format}
\DeclareAcroProperty {single-format}
\DeclareAcroProperty {list-format}
\DeclareAcroProperty {extra-format}

% Accessibility:
\acro_list_map:nn {short}
  {
    \DeclareAcroPropertyAlias {#1-acc} {#1}
    \acro_list_add:nn {short} {#1-acc}
  }

\DeclareAcroPropertyAlias {single-acc} {long-acc}
\acro_list_map:nn {long}
  {
    \DeclareAcroPropertyAlias {#1-acc} {#1}
    \acro_list_add:nn {long} {#1-acc}
  }

% --------------------------------------------------------------------------
% articles
\bool_new:N \l__acro_article_bool
\tl_new:N \g__acro_articles_tl

\cs_new_protected:Npn \acro_article_declare:nn #1#2
  {
    \tl_gput_right:Nn \g__acro_articles_tl {{#1}}
    \DeclareAcroProperty {#1}
    \acro_list_map:nn {short}
      { \DeclareAcroPropertyAlias {##1-#1} {#1} }
    \acro_list_map:nn {long}
      { \DeclareAcroPropertyAlias {##1-#1} {#1} }
    \bool_new:c {l__acro_article_#1_bool}
    \tl_new:c {l__acro_article_#1_tl}
    \exp_args:Nc \NewDocumentCommand {acro#1} {}
      { \use:c {acro_#1:} }
    \cs_new_protected:cpn {acro_#1:}
      {
        \bool_set_true:c {l__acro_article_#1_bool}
        \bool_set_true:N \l__acro_article_bool
      }
    \keys_define:nn {acro}
      {
        #1 .tl_set:c  = {l__acro_article_#1_tl} ,
        #1 .initial:n = #2
      }
  }

% #1: id
\cs_new_protected:Npn \__acro_set_article_defaults:n #1
  {
    \tl_map_tokens:Nn \g__acro_articles_tl
      { \__acro_default_article:nn {#1} }
  }

% #1: id
% #2: article
\cs_new_protected:Npn \__acro_default_article:nn #1#2
  { \acro_property_set:nnv {#1} {#2} {l__acro_article_#2_tl} }

% --------------------------------------------------------------------------
% use id as short entry:
\bool_new:N \g__acro_use_id_bool

\keys_define:nn {acro}
  {
    use-id-as-short         .choice: ,
    use-id-as-short / true  .code:n =
      \bool_gset_true:N \g__acro_use_id_bool ,
    use-id-as-short / false .code:n =
      \bool_gset_false:N \g__acro_use_id_bool ,
    use-id-as-short         .default:n = true
  }

% --------------------------------------------------------------------------
% mechanism for endings:
\tl_new:N \l__acro_endings_tl

\acro_attribute_new:n {short:endings}
\acro_attribute_new:n {long:endings}

\cs_new_protected:Npn \__acro_declare_ending_properties:n #1
  {
    \acro_property_declare:nnnnn
      { \c_false_bool }
      { \c_false_bool }
      { \c_false_bool }
      { \c_false_bool }
      {#1}
    \acro_property_declare:nnnnn
      { \c_false_bool }
      { \c_false_bool }
      { \c_false_bool }
      { \c_false_bool }
      {#1-form}
  }

% #1: ending
% #2: short default
% #3: long default
\cs_new_protected:Npn \acro_declare_ending:nnn #1#2#3
  {
    \bool_new:c {l__acro_#1_bool}
    \cs_new_protected:cpn {acro_#1:} { \bool_set_true:c {l__acro_#1_bool} }
    \exp_args:Nc \NewDocumentCommand {acro#1} {} { \use:c {acro_#1:} }
    \prg_new_conditional:cpnn {acro_if_#1:} {p,T,F,TF}
      {
        \bool_if:cTF {l__acro_#1_bool}
          { \prg_return_true: }
          { \prg_return_false: }
      }
    \tl_put_right:Nn \l__acro_endings_tl {{#1}}
    \keys_define:nn {acro}
      {
        short-#1-ending .code:n =
          \acro_attribute_set:nnn {short:endings} {#1} {##1} ,
        short-#1-ending .initial:n = #2 ,
        long-#1-ending .code:n =
          \acro_attribute_set:nnn {long:endings} {#1} {##1} ,
        long-#1-ending .initial:n = #3
      }
    \__acro_declare_ending_properties:n {#1}% plural + plural-form
    \acro_list_map:nn {short}
      {
        % short-plural + short-plural-form
        \__acro_declare_ending_properties:n {##1-#1}
        % short-plural = plural
        \acro_property_make_alias:nn {##1-#1} {#1}
      }
    \acro_list_map:nn {long}
      {
        % long-plural + long-plural-form
        \__acro_declare_ending_properties:n {##1-#1}
        % long-plural = plural
        \acro_property_make_alias:nn {##1-#1} {#1}
        % long-plural-form = plural-form
        \acro_property_make_alias:nn {##1-#1-form} {#1-form}
      }
  }

% #1: id
% #2: short|long
\cs_new_protected:Npn \__acro_set_endings:nn #1#2
  {
    \acro_list_map:nn {#2}
      {
         \tl_map_inline:Nn \l__acro_endings_tl
           { \__acro_set_ending:nnnn {#1} {#2} {##1} {####1} }
      }
  }

% #1: id
% #2: short|long
% #3: property
% #4: ending
\cs_new_protected:Npn \__acro_set_ending:nnnn #1#2#3#4
  {
    \acro_property_if_set:nnF {#1} {#3-#4-form}
      {
        \acro_property_if_set:nnF {#1} {#3-#4}
          {
            \__acro_property_set:nne {#1} {#3-#4}
              { \acro_attribute_get:nn {#2:endings} {#4} }
          }
      }
  }

% #1: id
\cs_new_protected:Npn \acro_set_endings:n #1
  {
    \__acro_set_endings:nn {#1} {short}
    \__acro_set_endings:nn {#1} {long}
  }

% --------------------------------------------------------------------------
% declaration of acronyms:
\seq_new:N \g__acro_acronyms_seq

\tl_new:N \l__acro_first_style_tl

\acro_attribute_new:n {acronyms}

\keys_define:nn {acro}
  {
    first-style .tl_set:N  = \l__acro_first_style_tl ,
    first-style .initial:n = long-short
  }

\cs_new_protected:Npn \acro_declare_acronym:nn #1#2
  { \acro_case_insensitive:Nn \__acro_declare_acronym:nn {#1} {#2} }

% #1: id
% #2: properties
\cs_new_protected:Npn \__acro_declare_acronym:nn #1#2
  {
    \int_new:c {g__acro_#1_int}
    \seq_new:c {g__acro_#1_pages_seq}
    \seq_new:c {g__acro_#1_barriers_seq}
    \acro_at_begin_document:n
      {
        \intarray_new:cn
          {g__acro_#1_barriers_intarray}
          { \g_acro_barrier_total_int }
      }
    \seq_gput_right:Nn \g__acro_acronyms_seq {#1}
    \acro_attribute_set:nnn {acronyms} {#1} {}
    % set defaults:
    \__acro_set_article_defaults:n {#1}
    % set user input:
    \acro_properties_set:nn {#1} {#2}
    % set defaults which must not be overwritten:
    \acro_property_set:nnn {#1} {usage} {0}
    \bool_lazy_and:nnT
      { \g__acro_use_id_bool }
      { !\acro_property_if_set_p:nn {#1} {short} }
      { \acro_property_set:nnn {#1} {short} {#1} }
    \acro_property_set:nnn {#1} {id} {#1}
    \acro_property_set_aliases:n {#1}
    % check mandatory properties:
    \acro_property_foreach_mandatory:n
      {
        \acro_property_if_set:nnF {#1} {##1}
          { \msg_error:nnnn {acro} {mandatory} {#1} {##1} }
      }
    % set endings:
    \acro_set_endings:n {#1}
    \acro_at_end_document:n
      {
        \acro_property_set:nnx {#1} {usage} { \int_use:c {g__acro_#1_int} }
        \acro_set_barriers:n {#1}
      }
  }

\prg_new_conditional:Npnn \acro_if_defined:n #1 {p,T,F,TF}
  {
    \acro_attribute_if_set:neTF {acronyms}
      { \acro_case_insensitive:n {#1} }
      { \prg_return_true: }
      { \prg_return_false: }
  }

\cs_new_protected:Npn \acro_check_definition:n #1
  {
    \acro_if_defined:nF {#1}
      { \msg_error:nnn {acro} {undefined} {#1} }
  }

% --------------------------------------------------------------------------
% use and reset:
\bool_new:N \l__acro_use_bool
\bool_set_true:N \l__acro_use_bool

\cs_new_protected:Npn \acro_use_false:
  { \bool_set_false:N \l__acro_use_bool }

\cs_new_protected:Npn \__acro_use:n #1
  {
    \bool_if:NT \l__acro_use_bool
      {
        \acro_property_set:nnn {#1} {used} {true}
        \acro_step:n {#1}
      }
  }

\cs_new_protected:Npn \acro_use:n #1
  { \clist_map_inline:nn {#1} { \__acro_use:n {#1} } }
\cs_generate_variant:Nn \acro_use:n {e}

\cs_new_protected:Npn \acro_use_all:
  { \seq_map_inline:Nn \g__acro_acronyms_seq { \__acro_use:n {##1} } }

\cs_new_protected:Npn \__acro_reset:n #1
  {
    \acro_property_set:nnn {#1} {used} {false}
    \int_gzero:c {g__acro_ \acro_case_insensitive:n {#1} _int}
    \int_compare:nNnF
      { \acro_property_get:nn {#1} {usage} } > 0
      { \acro_property_set:nnn {#1} {usage} {0} }
  }

\cs_new_protected:Npn \acro_reset:n #1
  { \clist_map_inline:nn {#1} { \__acro_reset:n {##1} } }

\cs_new_protected:Npn \acro_reset_all:
  { \seq_map_inline:Nn \g__acro_acronyms_seq { \__acro_reset:n {##1} } }

\cs_new_protected:Npn \acro_switch_off:
  { \bool_set_false:N \l__acro_use_bool }

\cs_new_protected:Npn \acro_switch_on:
  { \bool_set_true:N \l__acro_use_bool }

% --------------------------------------------------------------------------
% check for tags:
% #1: id
% #2: tag
\prg_new_protected_conditional:Npnn \acro_tag_if:nn #1#2 {T,F,TF}
  {
    \clist_set:Ne \l__acro_tmpa_clist { \acro_property_get:nn {#1} {tag} }
    \clist_if_in:NnTF \l__acro_tmpa_clist {#2}
      { \prg_return_true: }
      { \prg_return_false: }
  }
\prg_generate_conditional_variant:Nnn \acro_tag_if:nn {en} {T,F,TF}

% --------------------------------------------------------------------------
\AcroModuleEnd
